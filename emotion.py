import os
import openai
import json


# JSON 파일에서 API 키 불러오기
def load_api_key(filepath):
    with open(filepath, 'r') as file:
        config = json.load(file)
    return config["OPENAI_API_KEY"]


def emotion_keyword_extractor(diary_text):
    api_key = load_api_key("openai_key.json")
    os.environ["OPENAI_API_KEY"] = api_key
    prompt = f"""
    예시:
        일기: '친구들과 함께한 재미있는 파티로 정말 행복했다. 웃음이 끊이지 않았고, 모든 순간이 즐거웠다. 친구들과 함께 시간을 보내며 기쁨을 느꼈다. 나는 오랫동안 이런 행복을 느낀 적이 없었다. 이 날은 정말 잊을 수 없는 하루였다.'
        감정: '행복'

        일기: '사랑하는 사람과 이별하게 되어 마음이 많이 아팠다. 이별 후에 외로움과 슬픔이 나를 괴롭혔다. 나는 그 사람이 너무 그리웠고, 하루하루가 힘겨웠다. 우울한 감정이 나를 지배했고, 눈물이 자주 났다. 이별의 아픔은 생각보다 오래 지속되었다.'
        감정: '슬픔'

        일기: '누군가가 내 실수를 크게 지적했을 때, 나는 분노를 느꼈다. 화가 나서 속이 끓었고, 마음이 편치 않았다. 나는 그 사람에게 화를 내고 말았다. 나중에는 후회가 되었지만, 그때는 정말 화가 나서 어쩔 수 없었다. 분노가 나를 지배했다.'
        감정: '분노'

        일기: '어두운 밤 혼자 집에 가는 길이 두려웠다. 주변이 너무 조용하고 적막해서 불안했다. 나는 계속 주위를 살피며 걸었다. 집에 도착할 때까지 마음이 놓이지 않았다. 그날 밤은 정말 무서웠다.'
        감정: '두려움'

        일기: '생일날 친구들이 준비한 깜짝 파티에 정말 놀랐다. 아무런 예상도 못했기 때문에 충격을 받았다. 하지만 놀람과 동시에 기쁨도 느꼈다. 친구들이 이렇게나 나를 생각해준 것이 감사했다. 그 날은 정말 잊을 수 없는 추억이 되었다.'
        감정: '놀람'

        일기: '그녀와 처음 눈이 마주쳤을 때, 마음이 설레었다. 그녀의 미소가 너무 아름다워서, 나는 그 순간을 잊을 수 없다. 그녀와 함께 있는 시간은 항상 행복하고, 그녀를 생각만 해도 가슴이 뛴다.'
        감정: '사랑'

        일기: '친구가 내가 오래전부터 갖고 싶어했던 것을 먼저 구입했을 때, 나는 질투심을 느꼈다. 친구는 자랑스럽게 그것을 보여주었지만, 나는 마음 한 구석에서 부러움을 느꼈다. 질투는 나도 모르게 마음을 어둡게 만들었다.'
        감정: '질투'

        일기: '오랫동안 준비한 프로젝트가 마침내 성공적으로 완료되었다는 소식을 들었다. 이 소식을 듣고 나는 기쁘고 기대감에 차 있었다. 앞으로의 가능성과 기회에 대한 기대감이 마음을 설레게 했다.'
        감정: '기대감'

        일기: '연속된 야근과 잠 못 드는 밤이 계속되면서, 나는 지쳐만 갔다. 몸과 마음 모두 피곤함을 느꼈고, 아무것도 하고 싶지 않았다. 피곤함은 나의 일상을 무기력하게 만들었다.'
        감정: '피곤함'

        일기: '마감 기한이 다가오면서 스트레스가 계속 쌓였다. 일의 압박감이 커져갈수록 스트레스는 나를 옥죄었다. 스트레스는 나의 생각을 혼란스럽게 하고, 집중력을 떨어뜨렸다.'
        감정: '스트레스'
        
    감정 설명:
        감정: 감정: '행복'
        설명: 마음이 가볍고 기분이 좋으며, 즐거움과 만족감을 느끼는 상태입니다. 긍정적인 경험, 성취, 사랑하는 사람과의 좋은 관계 등으로 인해 발생합니다.
        
        감정: '슬픔'
        설명: 마음의 아픔, 상실감, 무력감이 주를 이루는 감정입니다. 소중한 것을 잃었거나, 기대에 못 미친 결과에 대한 반응으로 나타납니다.

        감정: '분노'
        설명: 불공평하거나 부당한 상황, 기대나 바람이 충족되지 않을 때 느끼는 강한 불쾌감과 적대감입니다. 종종 공격적인 행동으로 나타날 수 있습니다.
        
        감정: '두려움'
        설명: 위험하거나 부정적인 결과를 예상할 때 느끼는 긴장과 불안입니다. 신체적, 정신적 안전에 대한 위협을 느낄 때 발생합니다.
        
        감정: '놀람'
        설명: 예상치 못한 사건이나 변화에 대한 갑작스러운 반응입니다. 당황스럽거나 뜻밖의 일에 대해 빠르게 감정적 반응을 보입니다.

        감정: '사랑'
        설명: 강한 애착과 정서적 연결을 느끼는 상태입니다. 다른 사람에 대한 깊은 애정, 존경, 관심 등을 포함합니다.

        감정: '질투'
        설명: 다른 사람이 가진 것을 부러워하거나, 자신이 가진 것을 다른 사람에게 빼앗길까 두려워하는 감정입니다. 경쟁적인 상황에서 자주 발생합니다.

        감정: '기대감'
        설명: 미래에 대한 긍정적인 예측과 희망, 뭔가 좋은 일이 일어날 것 같은 기분입니다. 새로운 기회나 가능성에 대한 흥분을 포함합니다.

        감정: '피곤함'
        설명: 신체적, 정신적 에너지가 고갈되어 피로함을 느끼는 상태입니다. 장시간의 노동, 스트레스, 수면 부족 등으로 인해 발생합니다.

        감정: '스트레스'
        설명: 심리적 긴장과 압박감이 주된 요소입니다. 과도한 요구, 문제 해결의 어려움, 시간 압박 등으로 인해 나타납니다.

        일기: '{diary_text}'
        이 일기에서 느껴지는 감정은 다음 중 하나입니다: 행복, 슬픔, 분노, 두려움, 놀람, 사랑, 질투, 기대감, 피곤함, 스트레스. 감정은 무엇입니까?
        감정: """

    response = openai.chat.completions.create(
        model="gpt-4",
        temperature=0.3,
        top_p=0.7,
        frequency_penalty=0.5,
        messages=[
            {"role": "system", "content": "일기에서 주요 감정을 하나만 선택해주세요."},
            {"role": "user", "content": prompt}
        ]
    )

    # 모델 응답에서 감정 키워드 추출
    emotion = response.choices[0].message.content.strip()

    # 감정 키워드 유효성 검사
    valid_emotions = ['행복', '슬픔', '분노', '두려움', '놀람', '사랑', '질투', '기대감', '피곤함', '스트레스']
    if emotion in valid_emotions:
        return emotion
    else:
        return '혼합됨'